{
    "config_type": "deklar_aggregation",
    "config_version": 1,
    "description": "VATTool v1 deklar aggregation rules. Expressions are declarative and allow only sum and subtract.",
    "document_count_rules": {
        "sales_document_count": {
            "source_table": "prodagbi",
            "distinct_key_fields": [
                "document_type",
                "document_number",
                "document_date",
                "counterparty_vat"
            ],
            "note": "Provisional rule. Awaiting accountant confirmation."
        },
        "purchases_document_count": {
            "source_table": "pokupki",
            "distinct_key_fields": [
                "document_type",
                "document_number",
                "document_date",
                "counterparty_vat"
            ],
            "note": "Provisional rule. Awaiting accountant confirmation."
        }
    },
    "field_rules": [
        {
            "target_field": "sales_total_tax_base",
            "expression": {
                "op": "sum",
                "sources": [
                    {
                        "table": "prodagbi",
                        "field": "total_tax_base"
                    }
                ]
            },
            "note": "Fill 01-01 from prodagbi totals (placeholder source field name; adjust to match prodagbi schema)."
        },
        {
            "target_field": "sales_total_vat",
            "expression": {
                "op": "sum",
                "sources": [
                    {
                        "table": "prodagbi",
                        "field": "total_vat"
                    }
                ]
            },
            "note": "Fill 01-20 from prodagbi totals (placeholder source field name; adjust to match prodagbi schema)."
        },
        {
            "target_field": "total_tax_credit",
            "expression": {
                "op": "sum",
                "sources": [
                    {
                        "table": "pokupki",
                        "field": "vat_full_credit"
                    }
                ]
            },
            "note": "Total tax credit derived from pokupki (placeholder source field name; adjust to match pokupki schema)."
        },
        {
            "target_field": "vat_due",
            "expression": {
                "op": "subtract",
                "left": {
                    "op": "sum",
                    "sources": [
                        {
                            "table": "prodagbi",
                            "field": "total_vat"
                        }
                    ]
                },
                "right": {
                    "op": "sum",
                    "sources": [
                        {
                            "table": "pokupki",
                            "field": "vat_full_credit"
                        }
                    ]
                }
            },
            "note": "VAT due = sales_total_vat - total_tax_credit (must be >= 0; enforcement is runtime)."
        },
        {
            "target_field": "vat_refundable",
            "expression": {
                "op": "subtract",
                "left": {
                    "op": "sum",
                    "sources": [
                        {
                            "table": "prodagbi",
                            "field": "total_vat"
                        }
                    ]
                },
                "right": {
                    "op": "sum",
                    "sources": [
                        {
                            "table": "pokupki",
                            "field": "vat_full_credit"
                        }
                    ]
                }
            },
            "note": "VAT refundable uses same formula; runtime will place negative into refundable and 0 into due (implementation rule)."
        }
    ]
}